{% import 'macro_functions.html.twig' as mf %}
{% extends 'layout_default.html.twig' %}
{% block meta_title %}
    {{ 'Proxmox Configuration Templates' | trans }}
{% endblock %}
{% set active_menu = 'proxmox' %}

{% block content %}
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="#tab-vmtemplates" data-bs-toggle="tab">
                {{ 'VM Config Templates' | trans }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-new-vmtemplate" data-bs-toggle="tab">
                <svg class="icon me-2">
                    <use xlink:href="#plus" />
                </svg>
                {{ 'New VM Template' | trans }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-lxctemplates" data-bs-toggle="tab">
                {{ 'LXC Config Templates' | trans }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="#tab-new-lxctemplate" data-bs-toggle="tab">
                <svg class="icon me-2">
                    <use xlink:href="#plus" />
                </svg>
                {{ 'New LXC Template' | trans }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
        <a class="nav-link" href="#tab-appliance-templatevm" data-bs-toggle="tab">
            {{ 'Appliances & Template VMs' | trans }}
        </a>
    </li>
    </ul>

    <div class="card">
        <!-- ##############################################################################
                                        List VM Templates
             ############################################################################## -->
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-vmtemplates" role="tabpanel">
                <div class="card-body">
                    <h2>
                        {{ 'VM Config Templates' | trans }}
                    </h2>
                </div>

                {% set vmtemplates = admin.serviceproxmox_service_get_vmtemplates() %}
                <div style="padding: 0.25rem 1.5rem">
                    <strong>
                        All VM Config Templates 
                    </strong>
                </div>
                <table class="table card-table table-vcenter table-striped table-responsive text-nowrap">
                    <thead>
                        <tr>
                            <th>
                                {{ 'Name' | trans }}
                            </th>
                            <th>
                                {{ 'Description' | trans }}
                            </th>
                            <th>
                                {{ 'CPU Cores' | trans }}
                            </th>
                            <th>
                                {{ 'Memory' | trans }}
                            </th>
                            <th>
                                {{ 'Storage' | trans }}
                            </th>
                            <th>
                                {{ 'Created at' | trans }}
                            </th>
                            <th class="w-1"></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for template in vmtemplates %}
                        <tr>
                            <td>
                                {{ template.name }}
                            </td>
                            <td>
                                {{ template.description }}
                            </td>
                            <td>
                                {{ template.cores }}
                            </td>
                            <td>
                                {{ template.memory }} GB
                            </td>
                            <td>
                                {# {% set content = template.storage|split('\n') %}
                                {% for line in content %}
                                {{ line }}
                                <br>
                                {% endfor %} #}
                            </td>
                            <td>
                                {{ template.created_at }}
                            </td>

                            <td>
                                <a class="btn btn-icon" href="{{ '/serviceproxmox/templates/vm_config'|alink }}/{{ template.id }}">
                                    <svg class="icon">
                                        <use xlink:href="#edit" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ##############################################################################
                                        Form to create a new VM Template 
             ############################################################################## -->
        <div class="tab-content">
            <div class="tab-pane fade" id="tab-new-vmtemplate" role="tabpanel">
                <div class="card-body">
                    <form method="post" action="admin/serviceproxmox/vm_template_create" class="api-form" data-api-redirect="{{ 'serviceproxmox/templates'|alink }}">
                        <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}" />
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Name' | trans }}:    
                            </label>
                            <div class="col">
                                <input class="form-control" type="text" name="name" value="" required placeholder="{{ 'Unique name to identify this template' | trans }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Description' | trans }}:
                            </label>
                            <div class="col">
                                <input class="form-control" type="text-area" name="description" value="" required placeholder="{{ 'Description' | trans }}">
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'CPU Cores' | trans }}:                                                                    
                            </label>
                            <div class="col-md-5">
									<input class="form-range" type="range" name="cpu_cores" value="1" min="1" max="128" step="1" oninput="cpuOutput.value = this.value+' Core(s)';">
                            </div>
                            <div class="col-md-2">
                                <output name="cpuOutput" for="cpu_cores">
                                    1 Core(s)
                                </output>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Memory' | trans }}:                                                                    
                            </label>
                            <div class="col-md-5">
                                    <input class="form-range" type="range" name="vmmemory" value="1" min="1" max="128" step="1" oninput="vmmemoryOutput.value = this.value+' GB';">
                            </div>
                            <div class="col-md-2">
                                <output name="vmmemoryOutput" for="vmmemory">
                                    1 GB
                                </output>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Ballooning' | trans }}:                                                                            
                            </label>
                            <div class="col">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="radioBalloonYes" type="radio" name="balloon" value="1" checked>
                                <label class="form-check-label" for="radioBalloonYes">
                                    {{ 'Yes' | trans }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="radioBalloonNo" type="radio" name="balloon" value="0">
                                <label class="form-check-label" for="radioBalloonNo">
                                    {{ 'No' | trans }}
                                </label>
                            </div>
                        </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Ballooing Memory Size' | trans }}:                                                                                    
                            </label>
                            <!-- disable this if ballooning is not enabled -->
                        
                            <div class="col-md-5">
                                    <input class="form-range" type="range" name="balloon_size" value="1" min="1" max="128" step="1" oninput="memoryOutput.value = this.value+' GB';">
                            </div>
                            <div class="col-md-2">
                                <output name="memoryOutput" for="balloon_size">
                                    1 GB
                                </output>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'OS' | trans }}:
                            </label>
                            <!-- get os_list from the api -->
                            {% set os_list = admin.serviceproxmox_os_get_list() %}
                            <!-- dropdown menu with all available OS from constants provided by the module -->
                            <div class="col">
                                <select class="form-select" name="os">
                                    {% for os in os_list %}
                                    <option value="{{ os }}">{{ os }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Bios Type' | trans }}:
                            </label>
                            <!-- get bios_list from the api -->
                            {% set bios_list = admin.serviceproxmox_bios_get_list() %}
                            <!-- dropdown menu with all available BIOS from constants provided by the module -->
                            <div class="col">
                                <select class="form-select" name="bios">
                                    {% for bios in bios_list %}
                                    <option value="{{ bios }}">{{ bios }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Start on boot' | trans }}:
                            </label>
                            <div class="col">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="radioOnbootYes" type="radio" name="onboot" value="1" checked>
                                <label class="form-check-label" for="radioOnbootYes">
                                    {{ 'Yes' | trans }}
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" id="radioOnbootNo" type="radio" name="onboot" value="0">
                                <label class="form-check-label" for="radioOnbootNo">
                                    {{ 'No' | trans }}
                                </label>
                            </div>
                        </div>

                        </div>
                        <div class="mb-3 row">
                            <label class="form-label col-3 col-form-label">
                                {{ 'Qemu Guest Agent' | trans }}:
                            </label>
                            <div class="col">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="radioAgentYes" type="radio" name="agent" value="1" checked>
                                    <label class="form-check-label" for="radioAgentYes">
                                        {{ 'Enabled' | trans }}
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="radioAgentNo" type="radio" name="agent" value="0">
                                    <label class="form-check-label" for="radioAgentNo">
                                        {{ 'Disabled' | trans }}
                                    </label>
                                </div>
                            </div>
                        </div>
                        <input type="submit" value="{{ 'Save VM Template' | trans }}" class="btn btn-primary">
                    </form>
                </div>
            </div>
        </div>
       <!-- ##############################################################################
                                    List LXC Templates
            ############################################################################## -->

        {% set lxctemplates = admin.serviceproxmox_get_lxc_config_template() %}
        <div class="tab-content">
            <div class="tab-pane fade show" id="tab-lxctemplates" role="tabpanel">
                <div class="card-body">
                    <h2>
                        {{ 'LXC Config Templates' | trans }}
                    </h2>
                </div>

                <div style="padding: 0.25rem 1.5rem">
                    <strong>
                        All LXC Config Templates 
                    </strong>
                </div>
                <table class="table card-table table-vcenter table-striped text-nowrap">
                    <thead>
                        <tr>
                            <th>
                                {{ 'id' | trans }}
                            </th>
                            <th>
                                {{ 'Template' | trans }}
                            </th>
                            <th>
                                {{ 'CPU Cores' | trans }}
                            </th>
                            <th>
                                {{ 'Memory' | trans }}
                            </th>
                            <th>
                                {{ 'Storage' | trans }}
                            </th>
                            <th>
                                {{ 'Created at' | trans }}
                            </th>
                            <th class="w-1"></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for template in lxctemplates %}
                        <tr>
                            <td>
                                {{ template.id }}
                            </td>
                            <td>
                                {{ template.ostemplate }}
                            </td>
                            <td>
                                {{ template.cores }}
                            </td>
                            <td>
                                {{ template.memory }}
                            </td>
                            <td>
                                {{ template.storage }}
                            </td>
                            <td>
                                {{ template.created_at }}
                            </td>
                            <td>
                                <a class="btn btn-icon" href="{{ '/serviceproxmox/templates/lxc_config'|alink }}/{{ template.id }}">
                                    <svg class="icon">
                                        <use xlink:href="#edit" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ##############################################################################
                                        Create new LXC Template
             ############################################################################## -->
             {% set lxc_appliances = admin.serviceproxmox_lxc_appliance_get_list() %}
        <div class="tab-content">
            <div class="tab-pane fade" id="tab-new-lxctemplate" role="tabpanel">
                <div class="card-body">
                    <form method="post" action="admin/serviceproxmox/lxc_template_create" class="api-form" data-api-redirect="{{ 'serviceproxmox/templates'|alink }}">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}" />
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'Name' | trans }}:    
                        </label>
                        <div class="col">
                            <input class="form-control" type="text" name="name" value="" required placeholder="{{ 'Unique name to identify this LXC template' | trans }}">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'Description' | trans }}:
                        </label>
                        <div class="col">
                            <input class="form-control" type="text-area" name="description" value="" required placeholder="{{ 'Description' | trans }}">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'CPU Cores' | trans }}:                                                                    
                        </label>
                        <div class="col-md-5">
                                <input class="form-range" type="range" name="cpu_cores" value="1" min="1" max="128" step="1" oninput="cpuOutput.value = this.value+' Core(s)';">
                        </div>
                        <div class="col-md-2">
                            <output name="cpuOutput" for="cpu_cores">
                                1 Core(s)
                            </output>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'Memory' | trans }}:                                                                    
                        </label>
                        <div class="col-md-5">
                                <input class="form-range" type="range" name="memory" value="1" min="1" max="128" step="1" oninput="memoryOutput.value = this.value+' GB';">
                        </div>
                        <div class="col-md-2">
                            <output name="memoryOutput" for="memory">
                                1 GB
                            </output>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'Swap Memory Size' | trans }}:                                                                                    
                        </label>
                        <div class="col-md-5">
                                <input class="form-range" type="range" name="swap" value="1" min="1" max="16384" step="1" oninput="swapOutput.value = this.value+' MB';">
                        </div>
                        <div class="col-md-2">
                            <output name="swapOutput" for="swap">
                                1 GB
                            </output>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'OS Template' | trans }}:
                        </label>
                        <!-- get os_list from the api -->
                        <!-- dropdown menu with all available OS from constants provided by the module -->
                        <div class="col">
                            <select class="form-select" name="ostemplate">
                                {% for lxc_appliance in lxc_appliances %}
                                <option value="{{ lxc_appliance.id }}">{{ lxc_appliance.headline }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label class="form-label col-3 col-form-label">
                            {{ 'Start on boot' | trans }}:
                        </label>
                        <div class="col">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" id="radioOnbootYes" type="radio" name="onboot" value="1" checked>
                            <label class="form-check-label" for="radioOnbootYes">
                                {{ 'Yes' | trans }}
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" id="radioOnbootNo" type="radio" name="onboot" value="0">
                            <label class="form-check-label" for="radioOnbootNo">
                                {{ 'No' | trans }}
                            </label>
                        </div>
                    </div>
                    <input type="submit" value="{{ 'Save VM Template' | trans }}" class="btn btn-primary">
                    </form>
                </div>
            </div>
        </div>
        <!-- ##############################################################################
                                List LXC Appliances & Template VMs
        ############################################################################## -->
        {% set lxc_appliances = admin.serviceproxmox_lxc_appliance_get_list() %}
        <div class="tab-content">
        <div class="tab-pane fade show" id="tab-appliance-templatevm" role="tabpanel">
            <div class="card-body">
                <h2>
                    {{ 'LXC Appliances' | trans }}
                </h2>
            </div>
            <div class="card-body">
                <!-- function to update all lxc appliances -->
                <a class="btn btn-icon api-link" href="{{ 'api/admin/serviceproxmox/pull_lxc_appliances'|link({ 'CSRFToken': CSRFToken }) }}" title="{{ 'Get LXC Appliances' | trans }}" data-api-msg="{{ 'LXC Appliances Updated' | trans }}">
                    <svg class="icon">
                        <use xlink:href="#download"/>
                    </svg>
                </a>
            </div>
            <div class="card-body">
                <div style="padding: 0.25rem 1.5rem">
                    <strong>
                        All LXC Appliances 
                    </strong>
                </div>
                <table class="table card-table table-vcenter table-striped table-responsive text-nowrap">
                    <thead>
                    <tr>
                        <th>
                            {{ 'Type' | trans }}
                        </th>
                        <th>
                            {{ 'Description' | trans }}
                        </th>
                        <th>
                            {{ 'Architecture' | trans }}
                        </th>
                        <th>
                            {{ 'Version' | trans }}
                        </th>
                        <th class="w-1"></th>
                    </tr>
                    </thead>
                    <tbody>
                        {% for lxc_appliance in lxc_appliances %}
                        <tr>
                            <td>
                                {{ lxc_appliance.type }}
                            </td>
                            <td>
                                {{ lxc_appliance.description }}
                            </td>
                            <td>
                                {{ lxc_appliance.architecture }}
                            </td>
                            <td>
                                {{ lxc_appliance.version }}
                            </td>
                            <td>
                                <!-- TODO: Make this button open a Modal to select the Server & Storage where it should be stored -->
                                <a class="btn btn-icon" href=""> 
                                    <svg class="icon">
                                        <use xlink:href="#download" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-body">
                <!-- Here comes the list of all Templates VMs -->
            </div>
        </div>
    </div>
{% endblock %}